/**
 * 分时图数据
 */
import { TypeTimeOption } from "../time/config"
import jsonp from "./jsonp"
import config from '../../config/web'
import { time } from "../.."
import object_hash from 'object-hash'
import { datacache } from './datacache'


export interface Type_TimeData{
  /** 昨收 */
  pre_price: number,
  /** 分时总根数 */
  trendstotal: number,
  /** 价格位数 */
  decimal: number,
  name: string,
  code: string,
  market: number,
  /** 昨收 */
  hispreprices: {[key: string]: number},
  /** 时间分段 */
  tradeperiods:{
    pre: {
      b: number,
      e: number
    } | null,
    after: {
      b: number,
      e: number
    } | null,
    periods: Array<{
      b: number,
      e: number
    }>
  },
  trends: Array<{
    /** 序号 */
    index: number,
    /** 日期 */
    date: string,
    /** 时间 */
    time: string,
    /** 开盘价 */
    open: number,
    /** 最高价 */
    high: number,
    /** 最低价 */
    low: number,
    /** 最新价或(分钟收盘价) */
    new_price: number,
    /** 分钟均价 */
    average_price: number,
    /** 成交量 */
    volume: number,
    /** 百分比 */
    percent: string
  }>
}



/**
 * 分时图jsonp数据
 * @param options 
 * @returns 
 */
export async function timeData(options: TypeTimeOption):Promise<null | Type_TimeData>{

  let apiurl = config.getUrl('quote_api')

  let ndays = '1'  //默认为1，返回当天的分时数据，最大为5。如果ndays大于1，则iscr参数无效
  let iscr = '0'  //默认为1，1表示带盘前数据，0表示不带，仅在days为1时有效
  let iscca	= '0'	//默认为0，1表示带收盘集合竞价(或科创板盘后)数据，0表示不带，仅在days为1时有效


  switch (options.type) {
    case 'pq':
      iscr = '1'
      break;
    case 'ph':
      iscca = '1'
      break;
    case '2day':
      ndays = '2'
      apiurl = config.getUrl('quote_history_api')
      break;
    case '3day':
      ndays = '3'
      apiurl = config.getUrl('quote_history_api')
      break;
    case '4day':
      ndays = '4'
      apiurl = config.getUrl('quote_history_api')
      break;
    case '5day':
      ndays = '5'
      apiurl = config.getUrl('quote_history_api')
      break;      
    default:
      break;
  }

  try {
    const databack:any = await jsonp(
      `${apiurl}api/qt/stock/trends2/get?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f17&fields2=f51,f52,f53,f54,f55,f56,f57,f58&mpi=1000&ut=${options.ut}&secid=${options.quotecode}&ndays=${ndays}&iscr=${iscr}&iscca=${iscca}&wbp2u=1849325530509956|0|1|0|web`,
      {
        param: 'cb',
        prefix: 'quote_jp'
      }
    )    

    //盘前清空
    //databack = {"rc":0,"rt":10,"svr":182995396,"lt":1,"full":1,"dlmkts":"","data":{"code":"300059","market":0,"type":80,"status":0,"name":"东方财富","decimal":2,"preSettlement":0.0,"preClose":22.35,"beticks":"33300|34200|54000|34200|41400|46800|54000","trendsTotal":241,"time":1663290252,"kind":1,"prePrice":22.35,"tradePeriods":{"pre":{"b":202209160915,"e":202209160930},"after":{"b":202209161500,"e":202209161530},"periods":[{"b":202209160930,"e":202209161130},{"b":202209161300,"e":202209161500}]},"hisPrePrices":[{"date":20220916,"prePrice":22.35}],"trends":[]}};

    //盘前第一条
    //databack = {"rc":0,"rt":10,"svr":181233083,"lt":1,"full":1,"dlmkts":"","data":{"code":"300059","market":0,"type":80,"status":0,"name":"东方财富","decimal":2,"preSettlement":0.0,"preClose":22.35,"beticks":"33300|34200|54000|34200|41400|46800|54000","trendsTotal":241,"time":1663291008,"kind":1,"prePrice":22.35,"tradePeriods":{"pre":{"b":202209160915,"e":202209160930},"after":{"b":202209161500,"e":202209161530},"periods":[{"b":202209160930,"e":202209161130},{"b":202209161300,"e":202209161500}]},"hisPrePrices":[{"date":20220916,"prePrice":22.35}],"trends":["2022-09-16 09:30,22.25,22.20,22.35,22.19,0,0.00,22.350"]}}
    //最高和最低相等 
    //databack = {"rc":0,"rt":10,"svr":182481189,"lt":1,"full":1,"dlmkts":"","data":{"code":"003027","market":0,"type":6,"status":0,"name":"同兴环保","decimal":2,"preSettlement":0.0,"preClose":16.21,"beticks":"33300|34200|54000|34200|41400|46800|54000","trendsTotal":241,"time":1663551828,"kind":1,"prePrice":16.21,"tradePeriods":{"pre":{"b":202209190915,"e":202209190930},"after":null,"periods":[{"b":202209190930,"e":202209191130},{"b":202209191300,"e":202209191500}]},"hisPrePrices":[{"date":20220919,"prePrice":16.21}],"trends":["2022-09-19 09:30,17.83,17.83,17.83,17.83,4195,7479685.00,17.830","2022-09-19 09:31,17.83,17.83,17.83,17.83,2816,5020036.00,17.830","2022-09-19 09:32,17.83,17.83,17.83,17.83,147,262101.00,17.830","2022-09-19 09:33,17.83,17.83,17.83,17.83,120,213960.00,17.830","2022-09-19 09:34,17.83,17.83,17.83,17.83,172,306676.00,17.830","2022-09-19 09:35,17.83,17.83,17.83,17.83,102,180974.00,17.830","2022-09-19 09:36,17.83,17.83,17.83,17.83,191,340553.00,17.830","2022-09-19 09:37,17.83,17.83,17.83,17.83,61,108763.00,17.830","2022-09-19 09:38,17.83,17.83,17.83,17.83,129,230007.00,17.830","2022-09-19 09:39,17.83,17.83,17.83,17.83,148,263884.00,17.830","2022-09-19 09:40,17.83,17.83,17.83,17.83,361,643663.00,17.830","2022-09-19 09:41,17.83,17.83,17.83,17.83,51,90933.00,17.830","2022-09-19 09:42,17.83,17.83,17.83,17.83,537,957471.00,17.830","2022-09-19 09:43,17.83,17.83,17.83,17.83,86,153338.00,17.830","2022-09-19 09:44,17.83,17.83,17.83,17.83,66,117678.00,17.830"]}}

    //盘前有数据
    //databack = {"rc":0,"rt":10,"svr":182993670,"lt":1,"full":1,"dlmkts":"","data":{"hisPrePrices":[{"date":20220919,"prePrice":19.94}],"code":"300059","market":0,"type":80,"status":0,"name":"东方财富","decimal":2,"preSettlement":0.0,"preClose":19.94,"beticks":"33300|34200|54000|33300|34200|41400|46800|54000","trendsTotal":256,"time":1663550700,"kind":1,"prePrice":19.94,"tradePeriods":{"pre":{"b":202209190915,"e":202209190930},"after":{"b":202209191500,"e":202209191530},"periods":[{"b":202209190930,"e":202209191130},{"b":202209191300,"e":202209191500}]},"trends":["2022-09-19 09:15,19.94,19.94,19.94,19.94,0,0.00,19.940","2022-09-19 09:16,19.62,19.75,19.79,19.62,0,0.00,19.940","2022-09-19 09:17,19.79,19.72,19.79,19.71,0,0.00,19.940","2022-09-19 09:18,19.71,19.71,19.71,19.71,0,0.00,19.940","2022-09-19 09:19,19.71,19.71,19.71,19.71,0,0.00,19.940","2022-09-19 09:20,19.71,19.70,19.71,19.70,0,0.00,19.940","2022-09-19 09:21,19.70,19.70,19.70,19.70,0,0.00,19.940","2022-09-19 09:22,19.70,19.70,19.70,19.70,0,0.00,19.940","2022-09-19 09:23,19.70,19.70,19.70,19.70,0,0.00,19.940","2022-09-19 09:24,19.70,19.60,19.70,19.60,0,0.00,19.940","2022-09-19 09:25,19.60,19.52,19.60,19.51,0,0.00,19.940","2022-09-19 09:26,19.51,19.51,19.51,19.51,32457,63323919.00,19.510"]}}

    //databack = {"rc":0,"rt":10,"svr":182994500,"lt":1,"full":1,"dlmkts":"","data":{"code":"000065","market":0,"type":6,"status":0,"name":"北方国际","decimal":2,"preSettlement":0.0,"preClose":10.15,"tradePeriods":{"pre":{"b":202208250915,"e":202208250930},"after":null,"periods":[{"b":202208250930,"e":202208251130},{"b":202208251300,"e":202208251500}]},"beticks":"33300|34200|54000|34200|41400|46800|54000","trendsTotal":241,"time":1661240094,"kind":1,"prePrice":10.15,"hisPrePrices":[{"date":20220823,"prePrice":10.15}],"trends":["2022-08-23 09:30,10.33,10.33,10.33,10.33,8807,9097940.00,10.330","2022-08-23 09:31,10.36,10.32,10.38,10.19,26077,26875810.00,10.312","2022-08-23 09:32,10.29,10.19,10.36,10.18,11939,12277235.00,10.305","2022-08-23 09:33,10.18,10.18,10.20,10.11,7686,7819348.00,10.286","2022-08-23 09:34,10.18,10.23,10.28,10.17,6171,6314577.00,10.281","2022-08-23 09:35,10.21,10.18,10.27,10.18,5090,5209169.00,10.277","2022-08-23 09:36,10.19,10.18,10.28,10.18,8095,8295823.00,10.274","2022-08-23 09:37,10.17,10.11,10.17,10.09,6013,6087349.00,10.263","2022-08-23 09:38,10.10,10.12,10.12,10.05,6166,6226925.00,10.251","2022-08-23 09:39,10.13,10.08,10.14,10.08,4820,4873739.00,10.244","2022-08-23 09:40,10.10,10.18,10.19,10.09,5701,5786253.00,10.238","2022-08-23 09:41,10.21,10.31,10.37,10.21,17630,18136418.00,10.246","2022-08-23 09:42,10.33,10.28,10.33,10.22,7280,7488946.00,10.248","2022-08-23 09:43,10.27,10.24,10.30,10.21,6156,6322196.00,10.249","2022-08-23 09:44,10.23,10.23,10.26,10.21,2921,2990260.00,10.249","2022-08-23 09:45,10.25,10.22,10.27,10.22,3190,3267191.00,10.249","2022-08-23 09:46,10.22,10.23,10.30,10.22,4918,5052076.00,10.250","2022-08-23 09:47,10.22,10.20,10.24,10.20,1063,1086467.00,10.250","2022-08-23 09:48,10.20,10.22,10.22,10.19,1813,1848478.00,10.249","2022-08-23 09:49,10.20,10.34,10.37,10.20,6423,6619764.00,10.251","2022-08-23 09:50,10.33,10.27,10.33,10.26,1804,1857202.00,10.252","2022-08-23 09:51,10.28,10.28,10.32,10.27,4312,4441936.00,10.253","2022-08-23 09:52,10.28,10.23,10.29,10.23,2634,2707968.00,10.254","2022-08-23 09:53,10.22,10.23,10.24,10.21,2661,2722162.00,10.253","2022-08-23 09:54,10.23,10.23,10.24,10.21,1328,1358249.00,10.253","2022-08-23 09:55,10.23,10.27,10.29,10.23,2564,2632004.00,10.253","2022-08-23 09:56,10.27,10.20,10.27,10.20,1705,1744513.00,10.253","2022-08-23 09:57,10.21,10.17,10.21,10.17,1683,1714052.00,10.252","2022-08-23 09:58,10.16,10.17,10.17,10.16,2393,2432402.00,10.251","2022-08-23 09:59,10.17,10.15,10.18,10.15,1618,1644801.00,10.250","2022-08-23 10:00,10.16,10.20,10.22,10.15,1737,1771427.00,10.250","2022-08-23 10:01,10.20,10.18,10.20,10.18,1485,1513110.00,10.249","2022-08-23 10:02,10.18,10.17,10.18,10.15,2558,2598540.00,10.248","2022-08-23 10:03,10.17,10.15,10.18,10.15,1389,1411347.00,10.247","2022-08-23 10:04,10.16,10.16,10.17,10.14,1706,1733073.00,10.246","2022-08-23 10:05,10.16,10.17,10.19,10.15,2132,2167804.00,10.246","2022-08-23 10:06,10.17,10.14,10.17,10.12,2789,2828289.00,10.244","2022-08-23 10:07,10.14,10.19,10.20,10.14,3713,3778583.00,10.243","2022-08-23 10:08,10.18,10.14,10.18,10.14,1111,1129038.00,10.242","2022-08-23 10:09,10.14,10.15,10.20,10.14,3368,3426379.00,10.241","2022-08-23 10:10,10.15,10.16,10.18,10.15,1956,1988166.00,10.240","2022-08-23 10:11,10.15,10.14,10.16,10.14,2811,2854056.00,10.239","2022-08-23 10:12,10.14,10.11,10.14,10.11,2259,2286601.00,10.238","2022-08-23 10:13,10.11,10.13,10.17,10.11,2802,2842484.00,10.236","2022-08-23 10:14,10.14,10.12,10.15,10.12,5507,5556280.00,10.232","2022-08-23 10:15,10.13,10.18,10.20,10.12,3342,3397035.00,10.231","2022-08-23 10:16,10.18,10.18,10.20,10.18,2036,2075115.00,10.231","2022-08-23 10:17,10.18,10.15,10.19,10.15,2140,2175209.00,10.230","2022-08-23 10:18,10.15,10.14,10.16,10.14,1248,1267701.00,10.230","2022-08-23 10:19,10.14,10.16,10.16,10.14,1147,1163991.00,10.229","2022-08-23 10:20,10.15,10.18,10.20,10.15,3819,3892190.00,10.229","2022-08-23 10:21,10.17,10.19,10.20,10.16,1425,1450866.00,10.229","2022-08-23 10:22,10.19,10.18,10.19,10.18,801,815543.00,10.228","2022-08-23 10:23,10.17,10.16,10.18,10.15,926,941272.00,10.228","2022-08-23 10:24,10.16,10.15,10.17,10.15,873,886580.00,10.228","2022-08-23 10:25,10.15,10.20,10.21,10.15,1522,1548640.00,10.227","2022-08-23 10:26,10.19,10.17,10.20,10.17,2974,3019225.00,10.227","2022-08-23 10:27,10.17,10.14,10.18,10.14,3272,3309501.00,10.225","2022-08-23 10:28,10.15,10.17,10.18,10.15,1385,1407143.00,10.225","2022-08-23 10:29,10.17,10.14,10.17,10.14,432,438788.00,10.224","2022-08-23 10:30,10.14,10.16,10.16,10.14,1121,1137853.00,10.224","2022-08-23 10:31,10.16,10.18,10.19,10.16,1329,1352165.00,10.224","2022-08-23 10:32,10.17,10.13,10.17,10.13,970,984803.00,10.224","2022-08-23 10:33,10.13,10.13,10.16,10.13,1854,1881498.00,10.223","2022-08-23 10:34,10.13,10.14,10.15,10.13,481,487973.00,10.223","2022-08-23 10:35,10.14,10.12,10.15,10.12,1094,1107978.00,10.222","2022-08-23 10:36,10.12,10.11,10.13,10.11,839,848720.00,10.222","2022-08-23 10:37,10.10,10.09,10.12,10.08,1306,1320171.00,10.221","2022-08-23 10:38,10.09,10.10,10.11,10.09,1947,1965716.00,10.220","2022-08-23 10:39,10.10,10.10,10.10,10.09,1305,1317183.00,10.220","2022-08-23 10:40,10.10,10.09,10.10,10.08,867,874467.00,10.219","2022-08-23 10:41,10.09,10.10,10.11,10.07,1233,1244614.00,10.219","2022-08-23 10:42,10.10,10.07,10.10,10.07,842,848893.00,10.218","2022-08-23 10:43,10.07,10.06,10.08,10.04,2664,2678709.00,10.217","2022-08-23 10:44,10.06,10.10,10.10,10.05,3290,3314035.00,10.215","2022-08-23 10:45,10.10,10.08,10.10,10.08,705,711493.00,10.214","2022-08-23 10:46,10.08,10.09,10.09,10.07,1400,1410847.00,10.214","2022-08-23 10:47,10.08,10.07,10.09,10.07,2000,2015030.00,10.213","2022-08-23 10:48,10.07,10.06,10.07,10.05,1920,1930811.00,10.211","2022-08-23 10:49,10.05,10.04,10.06,10.04,1561,1569071.00,10.210","2022-08-23 10:50,10.05,10.00,10.06,10.00,5535,5548737.00,10.207","2022-08-23 10:51,10.00,10.05,10.06,10.00,3203,3215798.00,10.205","2022-08-23 10:52,10.05,10.05,10.07,10.04,1097,1102940.00,10.204","2022-08-23 10:53,10.05,10.04,10.08,10.04,2668,2684734.00,10.203","2022-08-23 10:54,10.04,10.06,10.06,10.04,2059,2070713.00,10.202","2022-08-23 10:55,10.06,10.06,10.10,10.06,1323,1333645.00,10.201","2022-08-23 10:56,10.06,10.09,10.09,10.06,1943,1957961.00,10.200","2022-08-23 10:57,10.10,10.05,10.10,10.05,2821,2841379.00,10.199","2022-08-23 10:58,10.05,10.05,10.07,10.05,1152,1158323.00,10.198","2022-08-23 10:59,10.05,10.04,10.06,10.04,443,445141.00,10.198","2022-08-23 11:00,10.04,10.04,10.06,10.04,1563,1571155.00,10.197","2022-08-23 11:01,10.04,10.04,10.04,10.03,496,497867.00,10.197","2022-08-23 11:02,10.04,10.03,10.04,10.02,2705,2710292.00,10.195","2022-08-23 11:03,10.03,10.04,10.04,10.00,1834,1839211.00,10.194","2022-08-23 11:04,10.05,10.06,10.06,10.05,1383,1389849.00,10.194","2022-08-23 11:05,10.06,10.03,10.06,10.00,2274,2278302.00,10.192","2022-08-23 11:06,10.02,10.02,10.04,10.00,3884,3890414.00,10.190","2022-08-23 11:07,10.02,10.03,10.03,10.00,3248,3251221.00,10.188","2022-08-23 11:08,10.01,10.02,10.03,10.00,1578,1580340.00,10.187","2022-08-23 11:09,10.03,10.00,10.03,10.00,1807,1808271.00,10.186","2022-08-23 11:10,10.01,10.04,10.04,10.01,1820,1824017.00,10.185","2022-08-23 11:11,10.03,10.02,10.05,10.02,1772,1775233.00,10.184","2022-08-23 11:12,10.02,10.01,10.02,9.99,1116,1116844.00,10.184","2022-08-23 11:13,10.01,9.99,10.01,9.99,911,910663.00,10.183","2022-08-23 11:14,9.99,10.00,10.00,9.99,1739,1738005.00,10.182","2022-08-23 11:15,9.99,9.96,10.00,9.95,3531,3519271.00,10.180","2022-08-23 11:16,9.96,9.99,10.00,9.96,1709,1707569.00,10.179","2022-08-23 11:17,9.98,10.00,10.00,9.98,1267,1266020.00,10.178","2022-08-23 11:18,9.99,9.97,9.99,9.97,2656,2646370.00,10.176","2022-08-23 11:19,9.97,9.98,9.98,9.96,1031,1028857.00,10.176","2022-08-23 11:20,9.98,9.98,9.99,9.97,663,661769.00,10.175","2022-08-23 11:21,9.98,9.99,9.99,9.98,1379,1377547.00,10.174","2022-08-23 11:22,9.99,9.99,10.00,9.98,1180,1179202.00,10.174","2022-08-23 11:23,9.99,9.99,10.00,9.98,1204,1202222.00,10.173","2022-08-23 11:24,9.98,9.99,10.00,9.98,1593,1592548.00,10.172","2022-08-23 11:25,9.99,10.01,10.01,9.99,843,842783.00,10.172","2022-08-23 11:26,10.01,10.01,10.01,9.99,829,829000.00,10.171","2022-08-23 11:27,9.99,10.00,10.00,9.99,1227,1226727.00,10.171","2022-08-23 11:28,9.99,9.99,10.01,9.99,668,667591.00,10.170","2022-08-23 11:29,9.99,9.96,9.99,9.96,1857,1852911.00,10.169","2022-08-23 11:30,9.97,9.99,9.99,9.96,1717,1712667.00,10.168","2022-08-23 13:01,9.98,9.98,10.00,9.97,3176,3170724.00,10.167","2022-08-23 13:02,9.98,10.02,10.02,9.96,2538,2536311.00,10.165","2022-08-23 13:03,10.03,10.04,10.05,10.01,2306,2311636.00,10.164","2022-08-23 13:04,10.02,10.00,10.02,10.00,875,875240.00,10.164","2022-08-23 13:05,10.00,10.03,10.03,9.99,1984,1986554.00,10.163","2022-08-23 13:06,10.04,10.04,10.06,10.03,1545,1552941.00,10.163","2022-08-23 13:07,10.04,10.07,10.08,10.04,1786,1794228.00,10.162","2022-08-23 13:08,10.06,10.05,10.08,10.05,1149,1156029.00,10.162","2022-08-23 13:09,10.05,10.02,10.05,10.02,4244,4247887.00,10.160","2022-08-23 13:10,10.02,10.03,10.04,10.00,2189,2192941.00,10.159","2022-08-23 13:11,10.04,10.06,10.07,10.03,886,890447.00,10.159","2022-08-23 13:12,10.06,10.04,10.06,10.03,502,503916.00,10.159","2022-08-23 13:13,10.04,10.02,10.04,10.02,1126,1129118.00,10.158","2022-08-23 13:14,10.02,10.01,10.02,10.00,414,414503.00,10.158","2022-08-23 13:15,10.01,10.02,10.02,10.01,265,265277.00,10.158","2022-08-23 13:16,10.01,10.02,10.02,10.01,826,827295.00,10.158","2022-08-23 13:17,10.02,10.02,10.02,10.01,300,300399.00,10.158","2022-08-23 13:18,10.02,10.05,10.05,10.02,846,849299.00,10.157","2022-08-23 13:19,10.05,10.03,10.06,10.02,3302,3311033.00,10.156","2022-08-23 13:20,10.03,10.02,10.04,10.02,348,348906.00,10.156","2022-08-23 13:21,10.02,10.07,10.07,10.02,1381,1387344.00,10.156","2022-08-23 13:22,10.06,10.16,10.16,10.06,5170,5235523.00,10.155","2022-08-23 13:23,10.15,10.15,10.16,10.14,3006,3052964.00,10.155","2022-08-23 13:24,10.16,10.17,10.22,10.14,4338,4424563.00,10.156","2022-08-23 13:25,10.17,10.22,10.23,10.17,2838,2892258.00,10.156","2022-08-23 13:26,10.22,10.26,10.26,10.20,4215,4314636.00,10.157","2022-08-23 13:27,10.26,10.22,10.26,10.19,6647,6791585.00,10.158","2022-08-23 13:28,10.21,10.18,10.21,10.18,979,997551.00,10.158","2022-08-23 13:29,10.18,10.17,10.20,10.17,708,720280.00,10.158","2022-08-23 13:30,10.17,10.15,10.19,10.15,1272,1293208.00,10.158","2022-08-23 13:31,10.15,10.12,10.15,10.12,1147,1162520.00,10.158","2022-08-23 13:32,10.12,10.11,10.13,10.10,1773,1791697.00,10.158","2022-08-23 13:33,10.11,10.15,10.15,10.10,1085,1097068.00,10.158","2022-08-23 13:34,10.16,10.18,10.20,10.15,2836,2885693.00,10.158","2022-08-23 13:35,10.18,10.14,10.18,10.13,560,568381.00,10.158","2022-08-23 13:36,10.14,10.14,10.16,10.13,1327,1347758.00,10.158","2022-08-23 13:37,10.14,10.18,10.19,10.14,1498,1524964.00,10.158","2022-08-23 13:38,10.18,10.22,10.22,10.18,1484,1513037.00,10.158","2022-08-23 13:39,10.22,10.15,10.24,10.15,6172,6303220.00,10.159","2022-08-23 13:40,10.16,10.18,10.20,10.16,812,827763.00,10.159","2022-08-23 13:41,10.19,10.22,10.22,10.18,1160,1184423.00,10.159","2022-08-23 13:42,10.21,10.21,10.21,10.19,710,724108.00,10.159","2022-08-23 13:43,10.21,10.23,10.24,10.21,2228,2279613.00,10.159","2022-08-23 13:44,10.23,10.19,10.23,10.19,996,1017240.00,10.160","2022-08-23 13:45,10.19,10.18,10.20,10.18,288,293473.00,10.160","2022-08-23 13:46,10.19,10.16,10.19,10.16,667,678672.00,10.160","2022-08-23 13:47,10.15,10.16,10.17,10.15,863,877061.00,10.160","2022-08-23 13:48,10.16,10.15,10.18,10.15,1086,1103512.00,10.160","2022-08-23 13:49,10.17,10.16,10.17,10.15,948,963894.00,10.160","2022-08-23 13:50,10.16,10.16,10.17,10.15,277,281342.00,10.160","2022-08-23 13:51,10.16,10.17,10.18,10.16,841,854977.00,10.160","2022-08-23 13:52,10.17,10.16,10.17,10.16,1139,1157500.00,10.160","2022-08-23 13:53,10.16,10.17,10.18,10.16,677,689102.00,10.160","2022-08-23 13:54,10.17,10.17,10.19,10.17,544,553540.00,10.160","2022-08-23 13:55,10.17,10.19,10.19,10.17,609,620025.00,10.160","2022-08-23 13:56,10.19,10.19,10.20,10.18,567,577250.00,10.160","2022-08-23 13:57,10.19,10.24,10.24,10.19,2055,2098310.00,10.160","2022-08-23 13:58,10.24,10.19,10.24,10.19,1369,1398087.00,10.160","2022-08-23 13:59,10.20,10.19,10.20,10.18,1098,1119037.00,10.160","2022-08-23 14:00,10.19,10.22,10.24,10.18,2914,2979287.00,10.161","2022-08-23 14:01,10.23,10.23,10.24,10.21,774,791466.00,10.161","2022-08-23 14:02,10.22,10.25,10.26,10.22,2643,2707826.00,10.161","2022-08-23 14:03,10.26,10.25,10.27,10.24,1991,2041760.00,10.162","2022-08-23 14:04,10.25,10.23,10.25,10.23,362,370706.00,10.162","2022-08-23 14:05,10.24,10.23,10.24,10.23,719,735972.00,10.162","2022-08-23 14:06,10.24,10.21,10.24,10.20,1979,2021394.00,10.162","2022-08-23 14:07,10.21,10.23,10.24,10.21,1058,1081934.00,10.162","2022-08-23 14:08,10.24,10.25,10.27,10.23,2275,2333084.00,10.163","2022-08-23 14:09,10.24,10.30,10.30,10.24,5595,5753229.00,10.164","2022-08-23 14:10,10.26,10.27,10.28,10.25,1349,1384752.00,10.164","2022-08-23 14:11,10.25,10.26,10.28,10.25,1122,1151948.00,10.165","2022-08-23 14:12,10.27,10.25,10.27,10.25,2059,2111952.00,10.165","2022-08-23 14:13,10.26,10.25,10.26,10.25,220,225128.00,10.165","2022-08-23 14:14,10.25,10.25,10.26,10.23,1045,1070528.00,10.165","2022-08-23 14:15,10.25,10.22,10.25,10.22,179,183159.00,10.165","2022-08-23 14:16,10.22,10.23,10.23,10.22,301,307860.00,10.165","2022-08-23 14:17,10.23,10.23,10.24,10.23,554,566819.00,10.166","2022-08-23 14:18,10.23,10.24,10.24,10.23,274,279885.00,10.166","2022-08-23 14:19,10.23,10.27,10.28,10.23,2897,2970568.00,10.166","2022-08-23 14:20,10.26,10.27,10.27,10.25,680,697893.00,10.166","2022-08-23 14:21,10.27,10.27,10.28,10.26,1411,1449109.00,10.167","2022-08-23 14:22,10.27,10.23,10.27,10.22,2955,3022493.00,10.167","2022-08-23 14:23,10.23,10.24,10.24,10.23,419,428953.00,10.167","2022-08-23 14:24,10.24,10.24,10.24,10.23,510,522235.00,10.167","2022-08-23 14:25,10.24,10.25,10.25,10.23,617,632175.00,10.167","2022-08-23 14:26,10.25,10.26,10.27,10.25,837,858269.00,10.167","2022-08-23 14:27,10.25,10.25,10.26,10.25,421,431563.00,10.167","2022-08-23 14:28,10.25,10.26,10.26,10.24,370,379110.00,10.167","2022-08-23 14:29,10.26,10.25,10.26,10.24,525,538244.00,10.168","2022-08-23 14:30,10.25,10.26,10.27,10.25,1356,1390456.00,10.168","2022-08-23 14:31,10.27,10.26,10.27,10.26,2034,2088094.00,10.168","2022-08-23 14:32,10.27,10.25,10.27,10.25,981,1005764.00,10.168","2022-08-23 14:33,10.25,10.25,10.26,10.24,959,982571.00,10.169","2022-08-23 14:34,10.25,10.24,10.25,10.24,703,719951.00,10.169","2022-08-23 14:35,10.24,10.24,10.26,10.24,987,1011471.00,10.169","2022-08-23 14:36,10.24,10.24,10.25,10.24,837,857371.00,10.169","2022-08-23 14:37,10.24,10.24,10.25,10.23,523,535252.00,10.169","2022-08-23 14:38,10.24,10.26,10.26,10.24,1861,1907802.00,10.169","2022-08-23 14:39,10.26,10.24,10.26,10.24,590,604232.00,10.169","2022-08-23 14:40,10.24,10.24,10.25,10.24,335,343241.00,10.169","2022-08-23 14:41,10.24,10.25,10.26,10.24,1225,1254844.00,10.170","2022-08-23 14:42,10.25,10.24,10.25,10.24,890,911661.00,10.170","2022-08-23 14:43,10.24,10.23,10.24,10.21,2624,2684090.00,10.170","2022-08-23 14:44,10.22,10.20,10.23,10.20,2040,2083856.00,10.170","2022-08-23 14:45,10.20,10.20,10.20,10.19,2122,2163822.00,10.170","2022-08-23 14:46,10.20,10.21,10.21,10.19,1552,1583009.00,10.171","2022-08-23 14:47,10.20,10.20,10.21,10.20,1475,1505106.00,10.171","2022-08-23 14:48,10.20,10.19,10.21,10.19,1010,1030754.00,10.171","2022-08-23 14:49,10.19,10.20,10.21,10.19,714,728351.00,10.171","2022-08-23 14:50,10.20,10.21,10.21,10.20,1457,1486654.00,10.171","2022-08-23 14:51,10.21,10.22,10.23,10.21,2445,2497279.00,10.171","2022-08-23 14:52,10.21,10.23,10.24,10.21,2125,2172408.00,10.171","2022-08-23 14:53,10.24,10.22,10.24,10.22,1699,1737516.00,10.171","2022-08-23 14:54,10.22,10.22,10.23,10.21,1051,1073706.00,10.172","2022-08-23 14:55,10.22,10.22,10.23,10.22,2925,2990034.00,10.172","2022-08-23 14:56,10.21,10.21,10.23,10.21,2634,2691428.00,10.172","2022-08-23 14:57,10.21,10.22,10.22,10.20,2997,3058679.00,10.172","2022-08-23 14:58,10.22,10.22,10.22,10.22,58,59185.00,10.172","2022-08-23 14:59,10.22,10.22,10.22,10.22,0,0.00,10.172","2022-08-23 15:00,10.21,10.21,10.21,10.21,3557,3631492.00,10.173"]}}


    //开盘前数据
    //databack = {"rc":0,"rt":10,"svr":182996485,"lt":1,"full":1,"dlmkts":"","data":{"code":"000065","market":0,"type":6,"status":0,"name":"北方国际","decimal":2,"preSettlement":0.0,"preClose":10.55,"beticks":"33300|34200|54000|34200|41400|46800|54000","trendsTotal":241,"time":1661735199,"kind":1,"prePrice":10.55,"tradePeriods":{"pre":{"b":202208290915,"e":202208290930},"after":null,"periods":[{"b":202208290930,"e":202208291130},{"b":202208291300,"e":202208291500}]},"volUnit":100,"hisPrePrices":[{"date":20220829,"prePrice":10.55}],"trends":[]}}

    return dealData(databack)
  } catch (error) {
    console.error(error)
  }

  return null
}

/** 通过sse获取分时图数据 */
export function timeDataSSE(timeobj:time, callback:Function){

  const options = timeobj.options

  let apiurl = config.getUrl('quote_push_api')

  let ndays = '1'  //默认为1，返回当天的分时数据，最大为5。如果ndays大于1，则iscr参数无效
  let iscr = '0'  //默认为1，1表示带盘前数据，0表示不带，仅在days为1时有效
  let iscca	= '0'	//默认为0，1表示带收盘集合竞价(或科创板盘后)数据，0表示不带，仅在days为1时有效


  switch (options.type) {
    case 'pq':
      iscr = '1'
      break;
    case 'ph':
      iscca = '1'
      break;
    case '2day':
      ndays = '2'
      apiurl = config.getUrl('quote_history_push_api')
      break;
    case '3day':
      ndays = '3'
      apiurl = config.getUrl('quote_history_push_api')
      break;
    case '4day':
      ndays = '4'
      apiurl = config.getUrl('quote_history_push_api')
      break;
    case '5day':
      ndays = '5'
      apiurl = config.getUrl('quote_history_push_api')
      break;      
    default:
      break;
  }

  try {
    timeobj.sse.close()
  } catch (error) {
    
  }

  timeobj.sse = new EventSource(`${apiurl}api/qt/stock/trends2/sse?fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f17&fields2=f51,f52,f53,f54,f55,f56,f57,f58&mpi=1000&ut=${options.ut}&secid=${options.quotecode}&ndays=${ndays}&iscr=${iscr}&iscca=${iscca}&wbp2u=1849325530509956|0|1|0|web`)

  timeobj.sse.onmessage = function(source_data:any){
    const data = JSON.parse(source_data.data) //dealData(JSON.parse(source_data.data))

    if(data.data != null){
      if(data.full == 1){ //全量数据
        timeobj.fulldata = data
      }

      if(data.full == 0 && data.data.trends && data.data.trends.length > 0 && timeobj.fulldata?.data?.trends){ //增量数据
        // timeobj.fulldata = Object.assign(timeobj.data, data.data)
        data.data.trends.forEach((v:string)=>{
          //尝试搜索有没有相同的时间
          timeobj.fulldata.data.trends = timeobj.fulldata.data.trends.filter((sv:string)=>{
            return v.substring(0,17) != sv.substring(0,17)
          })
        })
        timeobj.fulldata.data.trends = timeobj.fulldata.data.trends.concat(data.data.trends)
      }
      
      callback(dealData(timeobj.fulldata))
    }
  }
}

/** 处理分时数据接口数据 */
function dealData(source_data:any):Type_TimeData | null{
  try {
    if(source_data.data == null) return null

    const back = {
      pre_price: source_data.data.prePrice,
      trendstotal: source_data.data.trendsTotal,
      decimal: source_data.data.decimal,
      tradeperiods: source_data.data?.tradePeriods,
      hispreprices: getPrePriceList(source_data.data.hisPrePrices),
      name: source_data.data.name,
      code: source_data.data.code,
      market: source_data.data.market,
      
    } as any

    back.trends = source_data.data.trends.map((v:string, index:number)=>{
      const tempobj = v.split(',')
      // console.info(tempobj[3], parseFloat(tempobj[3]))
      
      return {
        index: index,
        date: tempobj[0].substring(0, 10),
        time: tempobj[0].substring(11),
        new_price: parseFloat(tempobj[2]),
        open: parseFloat(tempobj[1]) == 0 ? parseFloat(tempobj[2]) : parseFloat(tempobj[1]),
        high: parseFloat(tempobj[3]),
        low: parseFloat(tempobj[4]),
        close: parseFloat(tempobj[2]),
        average_price: parseFloat(tempobj[7]),
        volume: parseInt(tempobj[5]),
        // open_price: parseFloat(tempobj[1]),
        zde: parseFloat(tempobj[2]) - parseFloat(tempobj[1]),
        // pre_close: source_data.data.prePrice,
        percent: ((parseFloat(tempobj[2]) - source_data.data.prePrice) / source_data.data.prePrice * 100).toFixed(2) + '%'
      }
    })

    back.trends.map((v:any, index:number)=>{
      v.pre_close = (index == 0) ? source_data.data.prePrice : back.trends[index - 1].close
    })

    return back
  } catch (error) {
    console.error(error)
  }
  return null
}

export const pkyd_types = {
  "1": "有大买盘",
  "101": "有大卖盘",
  "2": "大笔买入",
  "102": "大笔卖出",
  "201": "封涨停板",
  "301": "封跌停板",
  "202": "打开涨停",
  "302": "打开跌停",
  "203": "高开5日线",
  "303": "低开5日线",
  "204": "60日新高",
  "304": "60日新低",
  "401": "向上缺口",
  "501": "向下缺口",
  "402": "火箭发射",
  "502": "高台跳水",
  "403": "快速反弹",
  "503": "快速下跌",
  "404": "竞价上涨",
  "504": "竞价下跌",
  "405": "60日大幅上涨",
  "505": "60日大幅下跌"
}


/** 盘口异动 */
export interface PKYD{
  /** 时间 */
  time: string,
  /** 股票代码 */
  code: string,
  /** 股票市场 */
  market: string,
  /** 股票名称 */
  name: string,
  /** 盘口移动代码 */
  pkydcode: string,
  /** 盘口移动标题 */
  title:string,
  /** 盘口异动说明 */
  intro: string,
  /** 盘口移动颜色 1为红色，2为绿色 */
  color: string
}

export async function getPKYDWithCache(quotecode: string, ut: string):Promise<null | Array<PKYD>> {
  const key = 'pkyd_' + quotecode + ut
  if(datacache.get(key)){
    return datacache.get(key)
  }
  else{
    const data = await getPKYD(quotecode, ut)
    datacache.set(key, data, 60)
    return data
  }
}

/** 获取盘口异动 */
export async function getPKYD(quotecode: string, ut: string):Promise<null | Array<PKYD>> {
  try {
    const databack:any = await jsonp(
      `${config.getUrl('quote_api')}api/qt/pkyd/get?fields=f1%2Cf2%2Cf3%2Cf4%2Cf5%2Cf6%2Cf7&secids=${quotecode}&lmt=40&ut=${ut}&wbp2u=1849325530509956|0|1|0|web`,
      {
        param: 'cb',
        prefix: 'quote_jp'
      }
    )

    if(databack && databack.data && databack.data.pkyd && databack.data.pkyd instanceof Array){
      return databack.data.pkyd.map((v:string)=>{
        //"09:32:00,688003,1,天准科技,304,25.15元,2"
        const temparray = v.split(',')
        return {
          time: temparray[0],
          code: temparray[1],
          market: temparray[2],
          name: temparray[3],
          pkydcode: temparray[4],
          title: pkyd_types[temparray[4] as keyof typeof pkyd_types],
          intro: temparray[5],
          color: temparray[6],
        }
      })
    }


  } catch (error) {
    console.error(error)
  }

  return null
}

/**
 * 获取昨收对象
 */
function getPrePriceList(input:any):{[key: string]: string}{
  const obj = {} as any
  try {
    input.forEach((v:any)=>{
      obj[transDate(v.date)] = v.prePrice
    })
  } catch (error) {
    
  }

  return obj
}

/**
 * 转化数字日期成字符串日期 20220914 => '2022-09-14'
 * @param input 
 * @returns 
 */
function transDate(input:number){
  const inputstr = input.toString()
  if(inputstr.length < 8) return inputstr
  return inputstr.substring(0, 4) + '-' + inputstr.substring(4, 6) + '-' + inputstr.substring(6, 8)
}